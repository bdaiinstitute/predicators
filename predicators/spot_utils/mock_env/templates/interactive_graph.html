<!DOCTYPE html>
<html>
<head>
    <title>State Transition Graph: {{ task_name }}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.3.2/cytoscape-dagre.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: #f5f5f5;
        }
        #cy {
            flex-grow: 1;
            z-index: 999;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        #info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        .close-button {
            float: right;
            cursor: pointer;
            padding: 5px;
        }
        .state-header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        .predicate {
            margin: 5px 0;
            font-family: monospace;
        }
        .self-loops {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #ccc;
        }
        .control-label {
            display: inline-block;
            margin-left: 5px;
        }
        #edge-info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        .effect-add {
            color: #2ca02c;  /* Green */
            font-family: monospace;
            margin: 2px 0;
        }
        .effect-delete {
            color: #d62728;  /* Red */
            font-family: monospace;
            margin: 2px 0;
        }
        .edge-header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        .section-header {
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="cy"></div>
    <div id="controls">
        <div>
            <input type="checkbox" id="shortest-path" checked title="Toggle shortest path visibility" aria-label="Toggle shortest path visibility">
            <label for="shortest-path" class="control-label">Show shortest path</label>
        </div>
        <div>
            <input type="checkbox" id="all-edges" checked title="Toggle all edges visibility" aria-label="Toggle all edges visibility">
            <label for="all-edges" class="control-label">Show all edges</label>
        </div>
        <div>
            <input type="checkbox" id="animate" checked title="Toggle animation" aria-label="Toggle animation">
            <label for="animate" class="control-label">Animate layout changes</label>
        </div>
        <div><button onclick="cy.layout(layout_options).run()">Reset Layout</button></div>
        <div style="margin-top: 10px">Press 'h' for keyboard shortcuts</div>
    </div>
    <div id="info-panel">
        <span class="close-button" onclick="hideInfoPanel()">×</span>
        <div id="state-info"></div>
    </div>
    <div id="edge-info-panel">
        <span class="close-button" onclick="hideEdgeInfoPanel()">×</span>
        <div id="edge-info"></div>
    </div>
    <script>
        const graphData = {{ graph_data_json }};
        
        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: graphData,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'white',
                        'border-width': 2,
                        'border-color': '#666',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'width': '120px',
                        'height': '50px',
                        'font-size': '12px',
                        'text-wrap': 'wrap',
                        'padding': '10px'
                    }
                },
                {
                    selector: 'node[?is_shortest_path]',
                    style: {
                        'background-color': '#fff7e6',
                        'border-color': '#ff7f0e',
                        'border-width': 3
                    }
                },
                {
                    selector: 'node[?is_initial]',
                    style: {
                        'background-color': '#e6f3ff',
                        'border-color': '#2171b5',
                        'border-width': 3
                    }
                },
                {
                    selector: 'node[?is_goal]',
                    style: {
                        'background-color': '#e6ffe6',
                        'border-color': '#2ca02c',
                        'border-width': 3
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#999',
                        'target-arrow-color': '#999',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'text-background-color': 'white',
                        'text-background-opacity': 1,
                        'text-background-padding': '5px',
                        'text-rotation': 'autorotate',
                        'text-margin-y': -10
                    }
                },
                {
                    selector: 'edge[?is_shortest_path][!affects_belief]',
                    style: {
                        'line-color': '#2171b5',  // Dark blue
                        'target-arrow-color': '#2171b5',
                        'width': 2.5
                    }
                },
                {
                    selector: 'edge[!is_shortest_path][!affects_belief]',
                    style: {
                        'line-color': '#87CEEB',  // Light blue
                        'target-arrow-color': '#87CEEB',
                        'width': 1,
                        'line-style': 'dashed'
                    }
                },
                {
                    selector: 'edge[?is_shortest_path][?affects_belief]',
                    style: {
                        'line-color': '#E74C3C',  // Bright red
                        'target-arrow-color': '#E74C3C',
                        'width': 3
                    }
                },
                {
                    selector: 'edge[!is_shortest_path][?affects_belief]',
                    style: {
                        'line-color': '#FFB6C1',  // Light red
                        'target-arrow-color': '#FFB6C1',
                        'width': 2,
                        'line-style': 'dashed'
                    }
                }
            ],
            layout: {
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 100,
                rankSep: 150,
                edgeSep: 50,
                animate: true
            },
            wheelSensitivity: 0.2
        });

        // Layout options
        const layout_options = {
            name: 'dagre',
            rankDir: 'LR',
            nodeSep: 100,
            rankSep: 150,
            edgeSep: 50,
            animate: document.getElementById('animate').checked
        };

        function formatStateInfo(fullLabel) {
            const lines = fullLabel.split('\n');
            let html = `<div class="state-header"><strong>${lines[0]}</strong></div>`;
            
            let section = [];
            for (let i = 2; i < lines.length; i++) {
                const line = lines[i];
                if (line === 'Self-loop operators:') {
                    if (section.length > 0) {
                        html += `<div class="predicates">${section.join('<br>')}</div>`;
                        section = [];
                    }
                    html += `<div class="self-loops"><strong>${line}</strong>`;
                } else if (line.trim() !== '') {
                    section.push(`<div class="predicate">${line}</div>`);
                }
            }
            if (section.length > 0) {
                html += `<div class="predicates">${section.join('')}</div>`;
            }
            return html;
        }

        function showInfoPanel(node) {
            const panel = document.getElementById('info-panel');
            const info = document.getElementById('state-info');
            info.innerHTML = formatStateInfo(node.data('fullLabel'));
            panel.style.display = 'block';
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function formatEdgeInfo(fullLabel) {
            const lines = fullLabel.split('\n');
            let html = `<div class="edge-header"><strong>${lines[0]}</strong></div>`;
            
            let section = [];
            for (let i = 2; i < lines.length; i++) {
                const line = lines[i];
                if (line.startsWith('+')) {
                    section.push(`<div class="effect-add">${line}</div>`);
                } else if (line.startsWith('-')) {
                    section.push(`<div class="effect-delete">${line}</div>`);
                } else {
                    if (section.length > 0) {
                        html += `<div class="effects">${section.join('')}</div>`;
                        section = [];
                    }
                    html += `<div class="section-header">${line}</div>`;
                }
            }
            if (section.length > 0) {
                html += `<div class="effects">${section.join('')}</div>`;
            }
            return html;
        }

        function showEdgeInfoPanel(edge) {
            const panel = document.getElementById('edge-info-panel');
            const info = document.getElementById('edge-info');
            info.innerHTML = formatEdgeInfo(edge.data('fullLabel'));
            panel.style.display = 'block';
        }

        function hideEdgeInfoPanel() {
            document.getElementById('edge-info-panel').style.display = 'none';
        }

        // Event handlers
        cy.on('tap', 'node', function(evt) {
            showInfoPanel(evt.target);
        });

        cy.on('tap', 'edge', function(evt) {
            showEdgeInfoPanel(evt.target);
            evt.preventDefault();
        });

        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                hideEdgeInfoPanel();
                hideInfoPanel();
            }
        });

        // Toggle controls
        document.getElementById('shortest-path').addEventListener('change', function(evt) {
            cy.edges('[?is_shortest_path]').style('visibility', evt.target.checked ? 'visible' : 'hidden');
        });

        document.getElementById('all-edges').addEventListener('change', function(evt) {
            cy.edges('[!is_shortest_path]').style('visibility', evt.target.checked ? 'visible' : 'hidden');
        });

        document.getElementById('animate').addEventListener('change', function(evt) {
            layout_options.animate = evt.target.checked;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(evt) {
            switch(evt.key.toLowerCase()) {
                case 'h':
                    alert(
                        'Keyboard Shortcuts:\n' +
                        'h: Show this help\n' +
                        's: Toggle shortest path\n' +
                        'e: Toggle all edges\n' +
                        'a: Toggle animation\n' +
                        'r: Reset layout\n' +
                        'Esc: Close info panel'
                    );
                    break;
                case 's':
                    const sp = document.getElementById('shortest-path');
                    sp.checked = !sp.checked;
                    sp.dispatchEvent(new Event('change'));
                    break;
                case 'e':
                    const ae = document.getElementById('all-edges');
                    ae.checked = !ae.checked;
                    ae.dispatchEvent(new Event('change'));
                    break;
                case 'a':
                    const an = document.getElementById('animate');
                    an.checked = !an.checked;
                    an.dispatchEvent(new Event('change'));
                    break;
                case 'r':
                    cy.layout(layout_options).run();
                    break;
                case 'escape':
                    hideInfoPanel();
                    break;
            }
        });

        // Print initial graph data
        console.log('Initial graph data:', graphData);
        console.log('Edges with shortest path:', cy.edges().filter(edge => edge.data('is_shortest_path')).length);
        console.log('Edges without shortest path:', cy.edges().filter(edge => !edge.data('is_shortest_path')).length);

        // Debug node data
        console.log('\nNode data:');
        cy.nodes().forEach(node => {
            console.log('Node:', node.id(), {
                'is_initial': node.data('is_initial'),
                'is_goal': node.data('is_goal'),
                'is_shortest_path': node.data('is_shortest_path'),
                'background-color': node.style('background-color'),
                'border-color': node.style('border-color')
            });
        });

        // Debug edge data
        console.log('\nEdge data:');
        cy.edges().forEach(edge => {
            console.log('Edge:', edge.id(), {
                'is_shortest_path': edge.data('is_shortest_path'),
                'line-color': edge.style('line-color'),
                'source': edge.data('source'),
                'target': edge.data('target')
            });
        });
    </script>
</body>
</html> 